<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raw Material Demand Dashboard</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { createClient } = supabase;

        const supabaseClient = createClient(
            'https://ntgxamggdtolnlevskjb.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50Z3hhbWdnZHRvbG5sZXZza2piIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNTE3NDMsImV4cCI6MjA3NDgyNzc0M30.r18wk6hrD3Qr4PgoQXIqskDsJCKO9jvLQCHQDDtJQvI'
        );

        function RawMaterialDemand() {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [lastUpdated, setLastUpdated] = useState(null);

            const fetchData = async () => {
                setLoading(true);
                setError(null);

                try {
                    const { data: fetchedData, error: fetchError } = await supabaseClient
                        .from('raw_material_demand')
                        .select('*')
                        .order('demand_date', { ascending: true });

                    if (fetchError) throw fetchError;

                    setData(fetchedData || []);
                    setLastUpdated(new Date());
                    console.log('‚úÖ Data loaded:', fetchedData?.length, 'records');
                } catch (err) {
                    console.error('‚ùå Error fetching data:', err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            // Optional: Listen for centralized data updates (future enhancement)
            useEffect(() => {
                const handleCentralData = (event) => {
                    console.log('üì¶ Received centralized data update');
                    if (event.detail?.weeklyDemand) {
                        // Filter for raw materials if your centralized data includes this
                        const rawMaterialData = event.detail.weeklyDemand.filter(
                            item => item.productType === 'raw_material'
                        );
                        if (rawMaterialData.length > 0) {
                            setData(rawMaterialData);
                            setLastUpdated(new Date());
                            setLoading(false);
                        }
                    }
                };

                window.addEventListener('dashboardDataUpdated', handleCentralData);

                return () => window.removeEventListener('dashboardDataUpdated', handleCentralData);
            }, []);

            useEffect(() => {
                fetchData();
            }, []);

            const organizeData = () => {
                const dates = [...new Set(data.map(d => d.demand_date))].sort();
                
                const plants = {
                    'Brentwood': { category: 'Concrete', materials: ['Concrete Sand', '1x4 Crush Rock', 'Peagravel'] },
                    'Pittsburg': { category: 'Concrete', materials: ['Concrete Sand', '1x4 Crush Rock', 'Peagravel'] },
                    'Asphalt Plant': { category: 'Asphalt', materials: ['Dust', 'Man Sand', '3/8', '1/2', '3/4'] }
                };

                return { dates, plants };
            };

            const getQuantity = (plantName, materialName, date) => {
                const record = data.find(
                    d => d.plant_name === plantName && 
                         d.material_name === materialName && 
                         d.demand_date === date
                );
                return record ? record.quantity_tons : null;
            };

            const getDailyTotal = (plantName, date) => {
                return data
                    .filter(d => d.plant_name === plantName && d.demand_date === date)
                    .reduce((sum, d) => sum + parseFloat(d.quantity_tons), 0);
            };

            const formatDate = (dateStr) => {
                const date = new Date(dateStr + 'T00:00:00');
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                return `${days[date.getDay()]} ${date.getMonth() + 1}/${date.getDate()}`;
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-pink-300 via-purple-300 to-red-300 p-8 flex items-center justify-center">
                        <div className="bg-white p-8 rounded-xl shadow-2xl">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto"></div>
                            <p className="mt-4 text-gray-600 font-semibold">Loading data...</p>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-pink-300 via-purple-300 to-red-300 p-8 flex items-center justify-center">
                        <div className="bg-white p-8 rounded-xl shadow-2xl max-w-md">
                            <div className="text-red-600 text-xl font-bold mb-4">‚ö†Ô∏è Error</div>
                            <p className="text-gray-700">{error}</p>
                            <button
                                onClick={fetchData}
                                className="mt-4 bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition"
                            >
                                Retry
                            </button>
                        </div>
                    </div>
                );
            }

            const { dates, plants } = organizeData();

            return (
                <div className="min-h-screen bg-gradient-to-br from-pink-300 via-purple-300 to-red-300 p-5">
                    <div className="max-w-7xl mx-auto bg-white rounded-xl shadow-2xl p-8">
                        <div className="flex justify-between items-center mb-8">
                            <h1 className="text-3xl font-bold text-gray-800">
                                üìä Raw Material Demand Forecast - 5 Day Schedule
                            </h1>
                            <button
                                onClick={fetchData}
                                className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition flex items-center gap-2"
                            >
                                <span>üîÑ</span>
                                Refresh
                            </button>
                        </div>

                        {lastUpdated && (
                            <div className="text-sm text-gray-600 mb-6">
                                Last updated: {lastUpdated.toLocaleString()}
                            </div>
                        )}

                        {/* CONCRETE SECTION */}
                        <div className="mb-12">
                            <div className="bg-gradient-to-r from-purple-600 to-purple-800 text-white text-2xl font-bold py-4 px-6 rounded-t-lg">
                                üèóÔ∏è CONCRETE RAW MATERIALS
                            </div>

                            {['Brentwood', 'Pittsburg'].map(plantName => (
                                <div key={plantName} className="mt-8">
                                    <div className="bg-gray-100 border-l-4 border-purple-600 py-3 px-4 font-bold text-lg text-gray-700 mb-2">
                                        {plantName.toUpperCase()} PLANT
                                    </div>

                                    <div className="overflow-x-auto shadow-lg">
                                        <table className="w-full border-collapse">
                                            <thead>
                                                <tr className="bg-gray-100">
                                                    <th className="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">
                                                        Raw Material
                                                    </th>
                                                    {dates.map(date => (
                                                        <th key={date} className="border border-gray-300 px-4 py-3 text-center font-semibold text-gray-700">
                                                            {formatDate(date)}
                                                        </th>
                                                    ))}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {plants[plantName].materials.map(material => (
                                                    <tr key={material} className="hover:bg-gray-50 transition">
                                                        <td className="border border-gray-300 px-4 py-2 bg-gray-50 font-medium">
                                                            {material} <span className="text-xs text-gray-500">(TONS)</span>
                                                        </td>
                                                        {dates.map(date => {
                                                            const qty = getQuantity(plantName, material, date);
                                                            return (
                                                                <td key={date} className="border border-gray-300 px-4 py-2 text-center font-mono">
                                                                    {qty !== null ? qty.toFixed(1) : <span className="text-gray-300">-</span>}
                                                                </td>
                                                            );
                                                        })}
                                                    </tr>
                                                ))}
                                                <tr className="bg-blue-50 font-bold">
                                                    <td className="border border-gray-300 px-4 py-2">
                                                        TOTAL
                                                    </td>
                                                    {dates.map(date => (
                                                        <td key={date} className="border border-gray-300 px-4 py-2 text-center font-mono">
                                                            {getDailyTotal(plantName, date).toFixed(1)}
                                                        </td>
                                                    ))}
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* ASPHALT SECTION */}
                        <div className="mb-8">
                            <div className="bg-gradient-to-r from-blue-700 to-blue-900 text-white text-2xl font-bold py-4 px-6 rounded-t-lg">
                                üõ£Ô∏è ASPHALT RAW MATERIALS
                            </div>

                            <div className="mt-8">
                                <div className="bg-gray-100 border-l-4 border-blue-700 py-3 px-4 font-bold text-lg text-gray-700 mb-2">
                                    ASPHALT PLANT
                                </div>

                                <div className="overflow-x-auto shadow-lg">
                                    <table className="w-full border-collapse">
                                        <thead>
                                            <tr className="bg-gray-100">
                                                <th className="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">
                                                    Raw Material
                                                </th>
                                                {dates.map(date => (
                                                    <th key={date} className="border border-gray-300 px-4 py-3 text-center font-semibold text-gray-700">
                                                        {formatDate(date)}
                                                    </th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {plants['Asphalt Plant'].materials.map(material => (
                                                <tr key={material} className="hover:bg-gray-50 transition">
                                                    <td className="border border-gray-300 px-4 py-2 bg-gray-50 font-medium">
                                                        {material} <span className="text-xs text-gray-500">(TONS)</span>
                                                    </td>
                                                    {dates.map(date => {
                                                        const qty = getQuantity('Asphalt Plant', material, date);
                                                        return (
                                                            <td key={date} className="border border-gray-300 px-4 py-2 text-center font-mono">
                                                                {qty !== null ? qty.toFixed(1) : <span className="text-gray-300">-</span>}
                                                            </td>
                                                        );
                                                    })}
                                                </tr>
                                            ))}
                                            <tr className="bg-blue-50 font-bold">
                                                <td className="border border-gray-300 px-4 py-2">
                                                    TOTAL
                                                </td>
                                                {dates.map(date => {
                                                    const total = getDailyTotal('Asphalt Plant', date);
                                                    return (
                                                        <td key={date} className="border border-gray-300 px-4 py-2 text-center font-mono">
                                                            {total > 0 ? total.toFixed(1) : <span className="text-gray-300">-</span>}
                                                        </td>
                                                    );
                                                })}
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        {/* NOTES */}
                        <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                            <div className="font-bold text-gray-800 mb-2">üìù Notes:</div>
                            <ul className="list-disc list-inside space-y-1 text-sm text-gray-700">
                                <li>All quantities shown in TONS</li>
                                <li>Concrete raw materials calculated from mix recipes (lbs/CY converted to tons)</li>
                                <li>Asphalt raw materials calculated after removing RAP content from total tonnage</li>
                                <li>Daily totals represent sum of all raw materials for that plant/day</li>
                                <li>Data refreshes automatically from Supabase database</li>
                            </ul>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RawMaterialDemand />);
    </script>
</body>
</html>