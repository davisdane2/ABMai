<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Concrete Demand Forecast</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            padding: 15px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 20px;
        }
        .plant-section {
            margin-bottom: 30px;
        }
        .plant-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            border-radius: 8px 8px 0 0;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
        }
        
        /* Mobile-first responsive table */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            min-width: 500px; /* Minimum width to prevent cramping */
            border-collapse: collapse;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 14px;
        }
        
        th {
            background: #f8f9fa;
            padding: 8px 6px;
            text-align: center;
            font-weight: 600;
            color: #495057;
            border: 1px solid #dee2e6;
            font-size: 12px;
            white-space: nowrap;
        }
        th:first-child {
            text-align: left;
            width: 100px;
            min-width: 100px;
        }
        td {
            padding: 8px 6px;
            text-align: center;
            border: 1px solid #dee2e6;
            font-size: 13px;
        }
        td:first-child {
            text-align: left;
            font-weight: 500;
            background: #f8f9fa;
            font-size: 12px;
        }
        .total-row {
            background: #e3f2fd;
            font-weight: bold;
        }
        .total-row td {
            background: #e3f2fd;
        }
        .qty-cell {
            font-family: 'Courier New', monospace;
        }
        tr:hover:not(.total-row) {
            background: #f5f5f5;
        }
        .empty-cell {
            color: #ccc;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 18px;
        }
        .error {
            text-align: center;
            padding: 40px;
            color: #e74c3c;
            font-size: 16px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Concrete Demand Forecast</h1>

        <div id="dashboard-content">
            <div class="loading">Loading demand data...</div>
        </div>
    </div>

    <script>
        // ===== SUPABASE CLIENT (FALLBACK) =====
        const { createClient } = supabase;
        const supabaseClient = createClient(
            'https://ntgxamggdtolnlevskjb.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50Z3hhbWdnZHRvbG5sZXZza2piIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNTE3NDMsImV4cCI6MjA3NDgyNzc0M30.r18wk6hrD3Qr4PgoQXIqskDsJCKO9jvLQCHQDDtJQvI'
        );

        // ===== DATA PROCESSING FUNCTIONS =====

        /**
         * Fetch concrete demand data directly from Supabase (fallback)
         */
        async function fetchConcreteDemandFromSupabase() {
            try {
                console.log('üîÑ Fetching data from Supabase...');

                const { data, error } = await supabaseClient
                    .from('concrete_demand')
                    .select('*')
                    .order('ship_date', { ascending: true });

                if (error) throw error;

                console.log('‚úÖ Fetched', data.length, 'records from Supabase');
                return data;
            } catch (error) {
                console.error('‚ùå Supabase fetch error:', error);
                throw error;
            }
        }

        /**
         * Process concrete demand data from centralized injection
         * Data structure from window.centralizedDashboardData.concrete_demand:
         * [{
         *   ship_date: "2025-10-16",
         *   plant_id: 1,
         *   plant_description: "BRENTWOOD",
         *   product_number: "605043105",
         *   product_description: "...",
         *   quantity: 38.5,
         *   unit: "YD",
         *   fetched_at: "...",
         *   last_updated: "..."
         * }, ...]
         */
        function processConcreteDemand(concreteDemandArray) {
            if (!concreteDemandArray || concreteDemandArray.length === 0) {
                showError('No concrete demand data available');
                return;
            }

            // Group data by plant
            const plantData = groupByPlant(concreteDemandArray);

            // Render tables for each plant
            renderDashboard(plantData);
        }

        /**
         * Group concrete demand by plant
         */
        function groupByPlant(data) {
            const plants = {};

            data.forEach(item => {
                const plantName = item.plant_description || `Plant ${item.plant_id}`;

                if (!plants[plantName]) {
                    plants[plantName] = [];
                }

                plants[plantName].push(item);
            });

            return plants;
        }

        /**
         * Get unique dates from data, sorted
         */
        function getUniqueDates(data) {
            const dates = [...new Set(data.map(item => item.ship_date))];
            return dates.sort();
        }

        /**
         * Get unique product numbers (mix designs), sorted
         */
        function getUniqueProducts(data) {
            const products = [...new Set(data.map(item => item.product_number))];
            return products.sort();
        }

        /**
         * Format date for display (MM/DD)
         */
        function formatDate(dateString) {
            const date = new Date(dateString);
            return `${date.getMonth() + 1}/${date.getDate()}`;
        }

        /**
         * Build table for a specific plant
         */
        function buildPlantTable(plantName, plantData) {
            const dates = getUniqueDates(plantData);
            const products = getUniqueProducts(plantData);

            // Create lookup map: product -> date -> quantity
            const dataMap = {};
            plantData.forEach(item => {
                if (!dataMap[item.product_number]) {
                    dataMap[item.product_number] = {};
                }

                // Aggregate quantities if multiple entries for same product/date
                if (dataMap[item.product_number][item.ship_date]) {
                    dataMap[item.product_number][item.ship_date] += item.quantity;
                } else {
                    dataMap[item.product_number][item.ship_date] = item.quantity;
                }
            });

            // Calculate totals per date
            const dateTotals = {};
            dates.forEach(date => {
                dateTotals[date] = 0;
                products.forEach(product => {
                    if (dataMap[product] && dataMap[product][date]) {
                        dateTotals[date] += dataMap[product][date];
                    }
                });
            });

            // Build HTML
            let html = `
                <div class="plant-section">
                    <div class="plant-header">${plantName}</div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Mix #</th>
            `;

            // Add date headers
            dates.forEach(date => {
                html += `<th>${formatDate(date)}</th>`;
            });

            html += `
                                </tr>
                            </thead>
                            <tbody>
            `;

            // Add product rows
            products.forEach(product => {
                html += `<tr><td>${product}</td>`;

                dates.forEach(date => {
                    const qty = dataMap[product][date];
                    if (qty) {
                        html += `<td class="qty-cell">${qty.toFixed(1)}</td>`;
                    } else {
                        html += `<td class="qty-cell empty-cell">-</td>`;
                    }
                });

                html += `</tr>`;
            });

            // Add total row
            html += `
                                <tr class="total-row">
                                    <td><strong>TOTAL</strong></td>
            `;

            dates.forEach(date => {
                html += `<td class="qty-cell"><strong>${dateTotals[date].toFixed(1)}</strong></td>`;
            });

            html += `
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            return html;
        }

        /**
         * Render complete dashboard with all plants
         */
        function renderDashboard(plantData) {
            const container = document.getElementById('dashboard-content');
            let html = '';

            // Sort plants alphabetically
            const sortedPlants = Object.keys(plantData).sort();

            sortedPlants.forEach(plantName => {
                html += buildPlantTable(plantName, plantData[plantName]);
            });

            container.innerHTML = html;
            console.log('‚úÖ Dashboard rendered successfully');
        }

        /**
         * Show error message
         */
        function showError(message) {
            const container = document.getElementById('dashboard-content');
            container.innerHTML = `<div class="error">‚ö†Ô∏è ${message}</div>`;
        }

        // ===== DATA INJECTION LISTENERS =====

        /**
         * Callback for centralized data updates (preferred method)
         */
        window.onDashboardDataUpdate = function(data) {
            console.log('üìä Dashboard data updated', data);

            if (data && data.concrete_demand) {
                processConcreteDemand(data.concrete_demand);
            } else {
                showError('Concrete demand data not available');
            }
        };

        /**
         * Initialize on load
         */
        window.addEventListener('DOMContentLoaded', async function() {
            console.log('üìÑ ConcWeekly dashboard loaded');
            console.log('üîç Checking for window.centralizedDashboardData...');
            console.log('window.centralizedDashboardData:', window.centralizedDashboardData);

            // Try centralized data first
            if (window.centralizedDashboardData) {
                console.log('‚úÖ centralizedDashboardData exists!');
                console.log('Keys available:', Object.keys(window.centralizedDashboardData));

                if (window.centralizedDashboardData.concrete_demand) {
                    console.log('‚úÖ concrete_demand found with', window.centralizedDashboardData.concrete_demand.length, 'records');
                    processConcreteDemand(window.centralizedDashboardData.concrete_demand);
                    return; // Success, exit early
                } else {
                    console.error('‚ùå concrete_demand not found in centralizedDashboardData');
                }
            } else {
                console.log('‚è≥ centralizedDashboardData not yet available');
            }

            // Fallback: Fetch directly from Supabase
            console.log('üîÑ Using Supabase fallback...');
            try {
                const data = await fetchConcreteDemandFromSupabase();
                processConcreteDemand(data);
            } catch (error) {
                showError('Failed to load data: ' + error.message);
            }
        });

        /**
         * Listen for custom data update events
         */
        window.addEventListener('dashboardDataUpdated', function(event) {
            console.log('üîÑ Dashboard data updated (event)', event.detail);

            if (event.detail && event.detail.concrete_demand) {
                processConcreteDemand(event.detail.concrete_demand);
            }
        });

        /**
         * Manual refresh function (called by iOS on resume)
         */
        window.refreshData = function() {
            console.log('üîÑ Manual refresh triggered');

            if (window.centralizedDashboardData && window.centralizedDashboardData.concrete_demand) {
                processConcreteDemand(window.centralizedDashboardData.concrete_demand);
            }
        };
    </script>
</body>
</html>
