<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asphalt Oil Demand Forecast</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            padding: 30px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 16px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #2c3e50;
            font-size: 18px;
        }
        .error {
            text-align: center;
            padding: 40px;
            color: #e74c3c;
            font-size: 16px;
        }

        /* AC Delivery Tracking Section */
        .delivery-tracking {
            margin-bottom: 40px;
            padding: 20px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        .delivery-tracking h2 {
            color: white;
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 22px;
            text-align: center;
        }
        .delivery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .delivery-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .delivery-card-header {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .delivery-detail {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 14px;
        }
        .delivery-label {
            color: #7f8c8d;
        }
        .delivery-value {
            font-weight: 600;
            color: #2c3e50;
        }
        .delivery-status {
            margin-top: 10px;
            padding: 5px 10px;
            border-radius: 4px;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
        }
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        .status-in-transit {
            background: #d1ecf1;
            color: #0c5460;
        }
        .status-delivered {
            background: #d4edda;
            color: #155724;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .summary-card {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }
        .summary-card.total {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }
        .card-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        .card-value {
            font-size: 32px;
            font-weight: bold;
        }
        .card-unit {
            font-size: 16px;
            opacity: 0.9;
        }

        /* Table Styles */
        .plant-section {
            margin-bottom: 40px;
        }
        .plant-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            color: #495057;
            border: 1px solid #dee2e6;
        }
        th:first-child {
            text-align: left;
            width: 200px;
        }
        td {
            padding: 10px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        td:first-child {
            text-align: left;
            font-weight: 500;
            background: #f8f9fa;
        }
        .total-row {
            background: #d4edda;
            font-weight: bold;
        }
        .total-row td {
            background: #d4edda;
        }
        .qty-cell {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }
        .oil-tons {
            color: #e74c3c;
        }
        .product-tons {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        tr:hover:not(.total-row) {
            background: #f5f5f5;
        }
        .empty-cell {
            color: #ccc;
        }
        .info-box {
            margin-top: 30px;
            padding: 20px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 4px;
        }
        .info-box h3 {
            margin-top: 0;
            color: #856404;
        }
        .info-box ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .info-box li {
            color: #856404;
            margin: 5px 0;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Asphalt Oil Demand Forecast</h1>
        <p class="subtitle">AC Oil Requirements</p>

        <div id="dashboard-content">
            <div class="loading">Loading oil demand data...</div>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        // Product numbers to track (from reference at bottom of original page)
        const AC_PRODUCTS = ['0021', '0027', '0024', '0001', '0007', '0040', '0050'];

        // ===== SUPABASE CLIENT =====
        const { createClient } = supabase;
        const supabaseClient = createClient(
            'https://ntgxamggdtolnlevskjb.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50Z3hhbWdnZHRvbG5sZXZza2piIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNTE3NDMsImV4cCI6MjA3NDgyNzc0M30.r18wk6hrD3Qr4PgoQXIqskDsJCKO9jvLQCHQDDtJQvI'
        );

        // ===== DATA FETCHING =====

        async function fetchAsphaltDemand() {
            const { data, error } = await supabaseClient
                .from('asphalt_demand')
                .select('*')
                .in('product_number', AC_PRODUCTS)
                .order('ship_date', { ascending: true });

            if (error) throw error;
            return data || [];
        }

        async function fetchAcContent() {
            const { data, error } = await supabaseClient
                .from('ac_content')
                .select('*');

            if (error) throw error;
            return data || [];
        }

        async function fetchIncomingOrders() {
            const { data, error } = await supabaseClient
                .from('ac_incoming_orders')
                .select('*')
                .order('expected_delivery_date', { ascending: true });

            if (error) throw error;
            return data || [];
        }

        async function fetchAllData() {
            try {
                console.log('üîÑ Fetching all AC Oil data...');

                const [asphaltData, acContentData, incomingOrders] = await Promise.all([
                    fetchAsphaltDemand(),
                    fetchAcContent(),
                    fetchIncomingOrders()
                ]);

                console.log('‚úÖ Fetched:', asphaltData.length, 'asphalt records,', acContentData.length, 'AC content records,', incomingOrders.length, 'incoming orders');

                return { asphaltData, acContentData, incomingOrders };
            } catch (error) {
                console.error('‚ùå Fetch error:', error);
                throw error;
            }
        }

        // ===== DATA PROCESSING =====

        function createAcContentMap(acContentData) {
            const map = {};
            acContentData.forEach(item => {
                // Real column names: product_number_ref, ac_content
                const oilContent = parseFloat(item.ac_content) || 0;
                map[item.product_number_ref] = oilContent / 100;
            });
            return map;
        }

        function getNextFiveDays() {
            const dates = [];
            const today = new Date();

            for (let i = 0; i < 10; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);

                // Skip Sundays (0 = Sunday)
                if (date.getDay() !== 0) {
                    const dateString = date.toISOString().split('T')[0];
                    dates.push(dateString);

                    if (dates.length === 5) break;
                }
            }

            return dates;
        }

        function formatDateWithDay(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const dayName = days[date.getDay()];
            return `${dayName} ${date.getMonth() + 1}/${date.getDate()}`;
        }

        function calculateOilDemand(asphaltData, acContentMap) {
            const dates = getNextFiveDays();

            // Group by product and date
            const dataMap = {};

            asphaltData.forEach(item => {
                if (!dataMap[item.product_number]) {
                    dataMap[item.product_number] = {};
                }

                if (dataMap[item.product_number][item.ship_date]) {
                    dataMap[item.product_number][item.ship_date] += item.quantity;
                } else {
                    dataMap[item.product_number][item.ship_date] = item.quantity;
                }
            });

            // Calculate oil requirements
            // Formula: productTons √ó 0.65 √ó oilContentPercent
            const oilRequirements = {};
            const productTotals = {};

            Object.keys(dataMap).forEach(product => {
                const oilPercent = acContentMap[product] || 0;

                if (!oilRequirements[product]) {
                    oilRequirements[product] = {};
                    productTotals[product] = {};
                }

                Object.keys(dataMap[product]).forEach(date => {
                    const productTons = dataMap[product][date];
                    const oilTons = productTons * 0.66 * oilPercent;

                    oilRequirements[product][date] = oilTons;
                    productTotals[product][date] = productTons;
                });
            });

            // Calculate daily totals
            const dailyTotals = {};
            dates.forEach(date => {
                dailyTotals[date] = 0;
                Object.keys(oilRequirements).forEach(product => {
                    if (oilRequirements[product][date]) {
                        dailyTotals[date] += oilRequirements[product][date];
                    }
                });
            });

            // Sort products by total oil requirement (descending)
            const productSums = {};
            Object.keys(oilRequirements).forEach(product => {
                productSums[product] = Object.values(oilRequirements[product])
                    .reduce((sum, val) => sum + val, 0);
            });

            const sortedProducts = Object.keys(productSums)
                .sort((a, b) => productSums[b] - productSums[a]);

            return {
                dates,
                oilRequirements,
                productTotals,
                dailyTotals,
                sortedProducts,
                acContentMap
            };
        }

        // ===== RENDERING =====

        function renderDeliveryTracking(incomingOrders) {
            if (!incomingOrders || incomingOrders.length === 0) {
                return '';
            }

            let html = `
                <div class="delivery-tracking">
                    <h2>üöö AC Delivery Tracking</h2>
                    <div class="delivery-grid">
            `;

            incomingOrders.forEach(order => {
                // Real column names: order_placed_confirmed (not status), estimated_delivery_date, entered_by, notes
                const statusClass = order.order_placed_confirmed === 'delivered' ? 'status-delivered' :
                                  order.order_placed_confirmed === 'in-transit' ? 'status-in-transit' :
                                  order.order_placed_confirmed === 'confirmed' ? 'status-in-transit' :
                                  'status-pending';

                html += `
                    <div class="delivery-card">
                        <div class="delivery-card-header">AC Oil Delivery #${order.id}</div>
                        <div class="delivery-detail">
                            <span class="delivery-label">Entered By:</span>
                            <span class="delivery-value">${order.entered_by || 'N/A'}</span>
                        </div>
                        <div class="delivery-detail">
                            <span class="delivery-label">Expected:</span>
                            <span class="delivery-value">${formatDateWithDay(order.estimated_delivery_date)}</span>
                        </div>
                        ${order.notes ? `
                        <div class="delivery-detail" style="grid-column: 1 / -1; margin-top: 5px;">
                            <span class="delivery-label">Notes:</span>
                            <span class="delivery-value" style="font-size: 12px; font-style: italic;">${order.notes}</span>
                        </div>
                        ` : ''}
                        <div class="delivery-status ${statusClass}">
                            ${(order.order_placed_confirmed || 'pending').toUpperCase()}
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            return html;
        }

        function renderSummaryCards(dates, dailyTotals) {
            let html = '<div class="summary-cards">';

            let grandTotal = 0;
            dates.forEach(date => {
                const total = dailyTotals[date] || 0;
                grandTotal += total;

                html += `
                    <div class="summary-card">
                        <div class="card-label">${formatDateWithDay(date)}</div>
                        <div class="card-value">${total.toFixed(2)}</div>
                        <div class="card-unit">tons oil</div>
                    </div>
                `;
            });

            html += `
                <div class="summary-card total">
                    <div class="card-label">5-Day Total</div>
                    <div class="card-value">${grandTotal.toFixed(2)}</div>
                    <div class="card-unit">tons oil</div>
                </div>
            `;

            html += '</div>';
            return html;
        }

        function renderOilTable(dates, sortedProducts, oilRequirements, productTotals, dailyTotals, acContentMap) {
            let html = `
                <div class="plant-section">
                    <div class="plant-header">ASPHALT PLANT - OIL REQUIREMENTS</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Product #</th>
            `;

            dates.forEach(date => {
                html += `<th>${formatDateWithDay(date)}</th>`;
            });

            html += `
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Product rows
            sortedProducts.forEach(product => {
                const oilPercent = acContentMap[product] || 0;
                const oilPercentDisplay = (oilPercent * 100).toFixed(2);

                html += `
                    <tr>
                        <td>${product} (${oilPercentDisplay}% oil)</td>
                `;

                dates.forEach(date => {
                    const oilTons = oilRequirements[product][date];
                    const productTons = productTotals[product][date];

                    if (oilTons && productTons) {
                        const formattedProductTons = productTons >= 1000 ?
                            productTons.toLocaleString('en-US') :
                            productTons.toFixed(0);

                        html += `
                            <td class="qty-cell">
                                <span class="oil-tons">${oilTons.toFixed(2)}</span><br>
                                <span class="product-tons">(${formattedProductTons} tons)</span>
                            </td>
                        `;
                    } else {
                        html += `<td class="qty-cell empty-cell">-</td>`;
                    }
                });

                html += `</tr>`;
            });

            // Total row
            html += `
                <tr class="total-row">
                    <td><strong>TOTAL OIL (TONS)</strong></td>
            `;

            dates.forEach(date => {
                const total = dailyTotals[date] || 0;
                if (total > 0) {
                    html += `<td class="qty-cell"><strong>${total.toFixed(2)}</strong></td>`;
                } else {
                    html += `<td class="qty-cell empty-cell"><strong>-</strong></td>`;
                }
            });

            html += `
                        </tr>
                    </tbody>
                </table>
            </div>
            `;

            return html;
        }

        function renderOilContentReference(sortedProducts, acContentMap) {
            let html = `
                <div class="info-box">
                    <h3>üìä Oil Content Reference</h3>
                    <ul>
            `;

            sortedProducts.forEach(product => {
                const oilPercent = acContentMap[product] || 0;
                const oilPercentDisplay = (oilPercent * 100).toFixed(2);

                html += `<li><strong>${product}</strong>: ${oilPercentDisplay}% oil content</li>`;
            });

            html += `
                    </ul>
                    <p><strong>Note:</strong> Oil tons are calculated using the formula: Product Tonnage √ó 0.66 (To Remove RAP) √ó Oil Content %</p>
                    <p><strong>Formula Explanation:</strong> The 0.66 multiplier accounts for the 34% reduction based on current RAP %</p>
                </div>
            `;

            return html;
        }

        function renderDashboard(data) {
            const { asphaltData, acContentData, incomingOrders } = data;

            // Create AC content lookup
            const acContentMap = createAcContentMap(acContentData);

            // Calculate oil demand
            const { dates, oilRequirements, productTotals, dailyTotals, sortedProducts } =
                calculateOilDemand(asphaltData, acContentMap);

            // Build HTML
            let html = '';

            // Delivery tracking section (first)
            html += renderDeliveryTracking(incomingOrders);

            // Summary cards
            html += renderSummaryCards(dates, dailyTotals);

            // Oil requirements table
            html += renderOilTable(dates, sortedProducts, oilRequirements, productTotals, dailyTotals, acContentMap);

            // Reference section
            html += renderOilContentReference(sortedProducts, acContentMap);

            document.getElementById('dashboard-content').innerHTML = html;
            console.log('‚úÖ Dashboard rendered successfully');
        }

        function showError(message) {
            document.getElementById('dashboard-content').innerHTML =
                `<div class="error">‚ö†Ô∏è ${message}</div>`;
        }

        // ===== DATA INJECTION LISTENERS =====

        window.onDashboardDataUpdate = function(data) {
            console.log('üìä Dashboard data updated', data);
            // Future: Use centralized data if available
        };

        // ===== INITIALIZATION =====

        window.addEventListener('DOMContentLoaded', async function() {
            console.log('üìÑ ACoilWeekly dashboard loaded');

            try {
                const data = await fetchAllData();
                renderDashboard(data);
            } catch (error) {
                showError('Failed to load data: ' + error.message);
            }
        });

        window.refreshData = function() {
            console.log('üîÑ Manual refresh triggered');
            window.location.reload();
        };
    </script>
</body>
</html>
