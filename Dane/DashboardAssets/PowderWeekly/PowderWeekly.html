<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Powder Weekly - Cement Demand Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .warning-high {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .7;
            }
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="min-h-screen bg-gradient-to-br from-gray-100 to-gray-200 p-8">
            <div class="max-w-7xl mx-auto">
                <div class="bg-white rounded-xl shadow-2xl p-8 mb-8">
                    <h1 class="text-4xl font-bold text-center mb-2 text-gray-900">
                        Cement / Flyash / Slag Demand
                    </h1>
                    <p class="text-center text-gray-600 text-lg mb-6">
                        Loading powder demand data...
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== SUPABASE CLIENT =====
        const { createClient } = supabase;
        const supabaseClient = createClient(
            'https://ntgxamggdtolnlevskjb.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50Z3hhbWdnZHRvbG5sZXZza2piIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNTE3NDMsImV4cCI6MjA3NDgyNzc0M30.r18wk6hrD3Qr4PgoQXIqskDsJCKO9jvLQCHQDDtJQvI'
        );

        // ===== DATA FETCHING =====
        async function fetchPowderDemands() {
            try {
                console.log('üîÑ Fetching powder demand data from Supabase...');

                const { data, error } = await supabaseClient
                    .from('powder_demand')
                    .select('*')
                    .order('ship_date', { ascending: true });

                if (error) throw error;

                console.log('‚úÖ Fetched', data.length, 'powder demand records');
                return data || [];
            } catch (error) {
                console.error('‚ùå Fetch error:', error);
                throw error;
            }
        }

        // ===== DATA PROCESSING =====
        function getNextFiveDays() {
            const dates = [];
            const today = new Date();

            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dateString = date.toISOString().split('T')[0];
                dates.push(dateString);

                if (dates.length === 5) break;
            }

            return dates;
        }

        function formatDateWithDay(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const dayName = days[date.getDay()];
            return `${dayName} ${date.getMonth() + 1}/${date.getDate()}`;
        }

        function processPowderData(rawData) {
            const dates = getNextFiveDays();
            const plants = ['PITTSBURG', 'BRENTWOOD'];
            const materials = ['Cement', 'Flyash', 'Slag'];

            // Create data structure: plant -> material -> date -> quantity
            const plantData = {};
            plants.forEach(plant => {
                plantData[plant] = {};
                materials.forEach(material => {
                    plantData[plant][material] = {};
                    dates.forEach(date => {
                        plantData[plant][material][date] = 0;
                    });
                });
            });

            // Aggregate data from powder_demand table
            rawData.forEach(item => {
                const plantName = item.plant_id.toUpperCase();
                const material = item.material_name;
                const date = item.ship_date;

                if (plants.includes(plantName) && materials.includes(material) && dates.includes(date)) {
                    plantData[plantName][material][date] += parseFloat(item.quantity) || 0;
                }
            });

            return { plantData, dates, plants, materials };
        }

        function calculateDispatchRecommendations(plantData, dates, plants) {
            const recommendations = [];

            dates.forEach(date => {
                let totalTons = 0;
                let totalFlyash = 0;

                plants.forEach(plant => {
                    const cement = plantData[plant]['Cement'][date] || 0;
                    const flyash = plantData[plant]['Flyash'][date] || 0;
                    const slag = plantData[plant]['Slag'][date] || 0;

                    totalTons += cement + flyash + slag;
                    totalFlyash += flyash;
                });

                const loads = totalTons / 27;
                const warnings = [];

                if (loads > 4) {
                    warnings.push('‚ö†Ô∏è DEMAND OVER 4 LOADS');
                }

                if (totalFlyash > 27) {
                    warnings.push('‚ö†Ô∏è EXCESSIVE FLYASH NEEDED');
                }

                recommendations.push({
                    date,
                    totalTons,
                    loads,
                    totalFlyash,
                    warnings
                });
            });

            return recommendations;
        }

        // ===== RENDERING =====
        function renderDispatchRecommendations(recommendations) {
            let html = `
                <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold mb-4 text-blue-900">üì¶ Dispatch Recommendations</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            `;

            recommendations.forEach(rec => {
                const hasWarnings = rec.warnings.length > 0;
                const cardClass = hasWarnings ? 'bg-red-100 border-red-400' : 'bg-white border-gray-200';
                const warningClass = rec.loads > 4 ? 'warning-high' : '';

                html += `
                    <div class="p-4 border-2 rounded-lg ${cardClass} ${warningClass}">
                        <div class="font-bold text-lg mb-2 text-gray-800">${formatDateWithDay(rec.date)}</div>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-700">Total Tons:</span>
                                <span class="font-semibold">${rec.totalTons.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-700">Loads Needed:</span>
                                <span class="font-bold text-xl ${rec.loads > 4 ? 'text-red-600' : 'text-green-600'}">
                                    ${rec.loads.toFixed(1)}
                                </span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Flyash Total:</span>
                                <span class="${rec.totalFlyash > 27 ? 'text-red-600 font-bold' : 'text-gray-800'}">
                                    ${rec.totalFlyash.toFixed(2)} tons
                                </span>
                            </div>
                            ${rec.warnings.length > 0 ? `
                                <div class="mt-3 space-y-1">
                                    ${rec.warnings.map(w => `
                                        <div class="text-red-700 font-bold text-sm">${w}</div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                    <div class="mt-4 text-sm text-gray-700">
                        <strong>Note:</strong> Loads calculated as Total Tons √∑ 27. Target: ‚â§4 loads per day.
                    </div>
                </div>
            `;

            return html;
        }

        function renderPlantSection(plantName, plantData, dates, materials) {
            html = `
                <div class="mb-8">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">${plantName}</h2>
                    <div class="overflow-x-auto shadow-lg rounded-lg">
                        <table class="min-w-full bg-white">
                            <thead>
                                <tr class="bg-gray-800 text-white">
                                    <th class="px-4 py-3 text-left font-semibold">Material</th>
            `;

            dates.forEach(date => {
                html += `<th class="px-4 py-3 text-center font-semibold">${formatDateWithDay(date)}</th>`;
            });

            html += `
                                </tr>
                            </thead>
                            <tbody>
            `;

            // Material rows
            const materialColors = {
                'Cement': { bg: 'bg-green-600', light: 'bg-green-100', text: 'text-green-800', hover: 'hover:bg-green-50' },
                'Flyash': { bg: 'bg-red-600', light: 'bg-red-100', text: 'text-red-800', hover: 'hover:bg-red-50' },
                'Slag': { bg: 'bg-yellow-500', light: 'bg-yellow-100', text: 'text-yellow-800', hover: 'hover:bg-yellow-50' }
            };

            materials.forEach(material => {
                const colors = materialColors[material];
                html += `
                    <tr class="border-b ${colors.hover} transition-colors">
                        <td class="px-4 py-3 font-semibold ${colors.bg} text-white">${material}</td>
                `;

                dates.forEach(date => {
                    const qty = plantData[material][date] || 0;
                    html += `
                        <td class="px-4 py-3 text-center ${colors.light}">
                            <span class="font-semibold ${colors.text}">${qty.toFixed(2)}</span>
                            <span class="text-xs text-gray-600 ml-1">tons</span>
                        </td>
                    `;
                });

                html += `</tr>`;
            });

            // Plant total row
            html += `
                <tr class="border-t-2 border-gray-800 bg-gray-100">
                    <td class="px-4 py-3 font-bold text-gray-900">${plantName} TOTAL</td>
            `;

            dates.forEach(date => {
                let total = 0;
                materials.forEach(material => {
                    total += plantData[material][date] || 0;
                });

                html += `
                    <td class="px-4 py-3 text-center">
                        <span class="font-bold text-gray-900 text-lg">${total.toFixed(2)}</span>
                        <span class="text-xs text-gray-700 ml-1">tons</span>
                    </td>
                `;
            });

            html += `
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            `;

            return html;
        }

        function renderDashboard(processedData) {
            const { plantData, dates, plants, materials } = processedData;
            const recommendations = calculateDispatchRecommendations(plantData, dates, plants);

            let html = `
                <div class="min-h-screen bg-gradient-to-br from-gray-100 to-gray-200 p-8">
                    <div class="max-w-7xl mx-auto">
                        <div class="bg-white rounded-xl shadow-2xl p-8 mb-8">
                            <h1 class="text-4xl font-bold text-center mb-2 text-gray-900">
                                Cement / Flyash / Slag Demand
                            </h1>
                            <p class="text-center text-gray-600 text-lg mb-6">
                                5-Day Forecast by Plant
                            </p>
                            <div class="flex justify-center gap-8 text-sm">
                                <div class="flex items-center gap-2">
                                    <div class="w-4 h-4 bg-green-600 rounded"></div>
                                    <span class="text-gray-700">Cement</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-4 h-4 bg-red-600 rounded"></div>
                                    <span class="text-gray-700">Flyash</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-4 h-4 bg-yellow-500 rounded"></div>
                                    <span class="text-gray-700">Slag</span>
                                </div>
                            </div>
                        </div>

                        ${renderDispatchRecommendations(recommendations)}
                        ${renderPlantSection('PITTSBURG', plantData['PITTSBURG'], dates, materials)}
                        ${renderPlantSection('BRENTWOOD', plantData['BRENTWOOD'], dates, materials)}

                        <div class="mt-8 p-6 bg-blue-50 border-l-4 border-blue-500 rounded-lg shadow">
                            <p class="text-sm text-gray-700">
                                <strong>Note:</strong> All quantities are displayed in tons. Data is sourced from the powder_demand table.
                                Values include cement, flyash, and slag components only.
                            </p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('root').innerHTML = html;
            console.log('‚úÖ Dashboard rendered successfully');
        }

        function showError(message) {
            document.getElementById('root').innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-gray-100 to-gray-200 p-8 flex items-center justify-center">
                    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl">
                        <h1 class="text-2xl font-bold text-red-600 mb-4">‚ö†Ô∏è Error Loading Data</h1>
                        <p class="text-gray-700">${message}</p>
                    </div>
                </div>
            `;
        }

        // ===== DATA INJECTION LISTENERS =====
        window.onDashboardDataUpdate = function(data) {
            console.log('üìä Dashboard data updated', data);
            // Future: Use centralized data if available
        };

        // ===== INITIALIZATION =====
        window.addEventListener('DOMContentLoaded', async function() {
            console.log('üìÑ PowderWeekly dashboard loaded');

            try {
                const rawData = await fetchPowderDemands();
                const processedData = processPowderData(rawData);
                renderDashboard(processedData);
            } catch (error) {
                showError('Failed to load powder demand data: ' + error.message);
            }
        });

        window.refreshData = function() {
            console.log('üîÑ Manual refresh triggered');
            window.location.reload();
        };
    </script>
</body>
</html>
