<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asphalt Demand Forecast</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 10px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            padding: 15px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 20px;
        }
        .plant-section {
            margin-bottom: 30px;
        }
        .plant-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 12px;
            border-radius: 8px 8px 0 0;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
        }
        
        /* Mobile-first responsive table */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            min-width: 600px; /* Minimum width to prevent cramping */
            border-collapse: collapse;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 14px;
        }
        
        th {
            background: #f8f9fa;
            padding: 8px 6px;
            text-align: center;
            font-weight: 600;
            color: #495057;
            border: 1px solid #dee2e6;
            font-size: 12px;
            white-space: nowrap;
        }
        th:first-child {
            text-align: left;
            width: 100px;
            min-width: 100px;
        }
        th:nth-child(2) {
            text-align: left;
            width: 120px;
            min-width: 90px;
            max-width: 180px;
        }
        td {
            padding: 8px 6px;
            text-align: center;
            border: 1px solid #dee2e6;
            font-size: 13px;
        }
        td:first-child {
            text-align: left;
            font-weight: 500;
            background: #f8f9fa;
            font-size: 12px;
        }
        .total-row {
            background: #e3f2fd;
            font-weight: bold;
        }
        .total-row td {
            background: #e3f2fd;
        }
        .qty-cell {
            font-family: 'Courier New', monospace;
        }
        tr:hover:not(.total-row) {
            background: #f5f5f5;
        }
        .empty-cell {
            color: #ccc;
        }
        .unit-label {
            font-size: 0.85em;
            color: #666;
            font-style: italic;
        }
        .section-separator {
            height: 20px;
            background: linear-gradient(to bottom, #e9ecef 0%, #ffffff 100%);
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #2a5298;
            font-size: 18px;
        }
        .error {
            text-align: center;
            padding: 40px;
            color: #e74c3c;
            font-size: 16px;
        }
        .grindings-header {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            padding: 12px;
            border-radius: 8px 8px 0 0;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Asphalt/RAP Products Demand</h1>

        <div id="dashboard-content">
            <div class="loading">Loading asphalt demand data...</div>
        </div>

        <div style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #2a5298;">
            <strong>Note:</strong> Total row includes only products measured in TONS. Products measured in EA (Each) are not included in the daily totals.
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const GRINDINGS_PRODUCTS = ['0125', '0126', '0127', '0160', '0123', '0121', '0120'];

        // ===== SUPABASE CLIENT (FALLBACK) =====
        const { createClient } = supabase;
        const supabaseClient = createClient(
            'https://ntgxamggdtolnlevskjb.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50Z3hhbWdnZHRvbG5sZXZza2piIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNTE3NDMsImV4cCI6MjA3NDgyNzc0M30.r18wk6hrD3Qr4PgoQXIqskDsJCKO9jvLQCHQDDtJQvI'
        );

        // ===== DATA PROCESSING FUNCTIONS =====

        /**
         * Fetch asphalt demand data directly from Supabase (fallback)
         */
        async function fetchAsphaltDemandFromSupabase() {
            try {
                console.log('🔄 Fetching asphalt demand data from Supabase...');

                const { data, error } = await supabaseClient
                    .from('asphalt_demand')
                    .select('*')
                    .order('ship_date', { ascending: true });

                if (error) throw error;

                console.log('✅ Fetched', data.length, 'records from Supabase');
                return data;
            } catch (error) {
                console.error('❌ Supabase fetch error:', error);
                throw error;
            }
        }

        /**
         * Process asphalt demand data
         */
        function processAsphaltDemand(asphaltDemandArray) {
            if (!asphaltDemandArray || asphaltDemandArray.length === 0) {
                showError('No asphalt demand data available');
                return;
            }

            console.log('📊 Processing', asphaltDemandArray.length, 'asphalt demand records');

            // Separate grindings/dumping products from regular products
            const grindingsData = asphaltDemandArray.filter(item =>
                GRINDINGS_PRODUCTS.includes(item.product_number)
            );

            const regularData = asphaltDemandArray.filter(item =>
                !GRINDINGS_PRODUCTS.includes(item.product_number)
            );

            // Render dashboard
            renderDashboard(grindingsData, regularData);
        }

        /**
         * Get unique dates from data, sorted
         */
        function getUniqueDates(data) {
            const dates = [...new Set(data.map(item => item.ship_date))];
            return dates.sort();
        }

        /**
         * Get unique product numbers, sorted
         */
        function getUniqueProducts(data) {
            const products = [...new Set(data.map(item => item.product_number))];
            return products.sort();
        }

        /**
         * Format date for display with day of week (Day MM/DD)
         */
        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const dayName = days[date.getDay()];
            return `${dayName} ${date.getMonth() + 1}/${date.getDate()}`;
        }

        /**
         * Build table for products
         */
        function buildProductTable(sectionTitle, data, headerClass = 'plant-header', isGrindings = false) {
            if (!data || data.length === 0) {
                return '';
            }

            const dates = getUniqueDates(data);
            const products = getUniqueProducts(data);

            // Create lookup map: product -> {description, unit, dates}
            const dataMap = {};
            data.forEach(item => {
                if (!dataMap[item.product_number]) {
                    // For GRINDINGS section, override unit to TONS
                    const unit = isGrindings ? 'TONS' : (item.unit || 'TONS');

                    dataMap[item.product_number] = {
                        description: item.product_description || '',
                        unit: unit,
                        dates: {}
                    };
                }

                // Aggregate quantities if multiple entries for same product/date
                if (dataMap[item.product_number].dates[item.ship_date]) {
                    dataMap[item.product_number].dates[item.ship_date] += item.quantity;
                } else {
                    dataMap[item.product_number].dates[item.ship_date] = item.quantity;
                }
            });

            // Calculate totals per date (TONS only)
            const dateTotals = {};
            dates.forEach(date => {
                dateTotals[date] = 0;
                products.forEach(product => {
                    const productData = dataMap[product];
                    if (productData && productData.unit === 'TONS' && productData.dates[date]) {
                        dateTotals[date] += productData.dates[date];
                    }
                });
            });

            // Build HTML
            let html = `
                <div class="plant-section">
                    <div class="${headerClass}">${sectionTitle}</div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Product #</th>
                                    <th>Description</th>
            `;

            // Add date headers
            dates.forEach(date => {
                html += `<th>${formatDate(date)}</th>`;
            });

            html += `
                                </tr>
                            </thead>
                            <tbody>
            `;

            // Add product rows
            products.forEach(product => {
                const productData = dataMap[product];
                const unit = productData.unit;
                const description = productData.description;

                html += `<tr>
                    <td>${product} <span class="unit-label">(${unit})</span></td>
                    <td style="text-align: left; font-size: 11px; color: #666;">${description}</td>`;

                dates.forEach(date => {
                    const qty = productData.dates[date];
                    if (qty) {
                        // Format with commas for thousands
                        const formattedQty = qty >= 1000 ? qty.toLocaleString('en-US') : qty.toFixed(qty % 1 === 0 ? 0 : 1);
                        html += `<td class="qty-cell">${formattedQty}</td>`;
                    } else {
                        html += `<td class="qty-cell empty-cell">-</td>`;
                    }
                });

                html += `</tr>`;
            });

            // Add total row (TONS only)
            html += `
                                <tr class="total-row">
                                    <td colspan="2"><strong>TOTAL (TONS only)</strong></td>
            `;

            dates.forEach(date => {
                const total = dateTotals[date];
                if (total > 0) {
                    const formattedTotal = total >= 1000 ? total.toLocaleString('en-US') : total.toFixed(0);
                    html += `<td class="qty-cell"><strong>${formattedTotal}</strong></td>`;
                } else {
                    html += `<td class="qty-cell empty-cell"><strong>-</strong></td>`;
                }
            });

            html += `
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            return html;
        }

        /**
         * Render complete dashboard
         */
        function renderDashboard(grindingsData, regularData) {
            const container = document.getElementById('dashboard-content');
            let html = '';

            // Grindings/Dumping section first (if data exists)
            if (grindingsData && grindingsData.length > 0) {
                html += buildProductTable('GRINDINGS / DUMPING', grindingsData, 'grindings-header', true);
                html += '<div class="section-separator"></div>';
            }

            // Regular products section
            html += buildProductTable('ASPHALT PLANT', regularData, 'plant-header', false);

            container.innerHTML = html;
            console.log('✅ Dashboard rendered successfully');
        }

        /**
         * Show error message
         */
        function showError(message) {
            const container = document.getElementById('dashboard-content');
            container.innerHTML = `<div class="error">⚠️ ${message}</div>`;
        }

        // ===== DATA INJECTION LISTENERS =====

        /**
         * Callback for centralized data updates (preferred method)
         */
        window.onDashboardDataUpdate = function(data) {
            console.log('📊 Dashboard data updated', data);

            if (data && data.asphalt_demand) {
                processAsphaltDemand(data.asphalt_demand);
            } else {
                showError('Asphalt demand data not available');
            }
        };

        /**
         * Initialize on load
         */
        window.addEventListener('DOMContentLoaded', async function() {
            console.log('📄 AsphaltWeekly dashboard loaded');
            console.log('🔍 Checking for window.centralizedDashboardData...');
            console.log('window.centralizedDashboardData:', window.centralizedDashboardData);

            // Try centralized data first
            if (window.centralizedDashboardData) {
                console.log('✅ centralizedDashboardData exists!');
                console.log('Keys available:', Object.keys(window.centralizedDashboardData));

                if (window.centralizedDashboardData.asphalt_demand) {
                    console.log('✅ asphalt_demand found with', window.centralizedDashboardData.asphalt_demand.length, 'records');
                    processAsphaltDemand(window.centralizedDashboardData.asphalt_demand);
                    return; // Success, exit early
                } else {
                    console.error('❌ asphalt_demand not found in centralizedDashboardData');
                }
            } else {
                console.log('⏳ centralizedDashboardData not yet available');
            }

            // Fallback: Fetch directly from Supabase
            console.log('🔄 Using Supabase fallback...');
            try {
                const data = await fetchAsphaltDemandFromSupabase();
                processAsphaltDemand(data);
            } catch (error) {
                showError('Failed to load data: ' + error.message);
            }
        });

        /**
         * Listen for custom data update events
         */
        window.addEventListener('dashboardDataUpdated', function(event) {
            console.log('🔄 Dashboard data updated (event)', event.detail);

            if (event.detail && event.detail.asphalt_demand) {
                processAsphaltDemand(event.detail.asphalt_demand);
            }
        });

        /**
         * Manual refresh function (called by iOS on resume)
         */
        window.refreshData = function() {
            console.log('🔄 Manual refresh triggered');

            if (window.centralizedDashboardData && window.centralizedDashboardData.asphalt_demand) {
                processAsphaltDemand(window.centralizedDashboardData.asphalt_demand);
            }
        };
    </script>
</body>
</html>